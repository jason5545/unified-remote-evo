name: Build and Release APK

on:
  push:
    tags:
      - 'v*'  # ç•¶æ¨é€ v1.0.0 ç­‰ tag æ™‚è§¸ç™¼
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  build:
    name: Build Signed APK
    runs-on: ubuntu-latest

    steps:
      # 1. æª¢å‡ºç¨‹å¼ç¢¼
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è¨­å®š JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. è³¦äºˆ Gradle åŸ·è¡Œæ¬Šé™
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. æª¢æŸ¥ä¸¦ç”¢ç”Ÿç°½ç½²é‡‘é‘°ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      - name: Setup Signing Key
        run: |
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ° KEYSTORE_BASE64ï¼Œè‡ªå‹•ç”¢ç”Ÿæ–°çš„ç°½ç½²é‡‘é‘°..."

            # ç”¢ç”Ÿéš¨æ©Ÿå¯†ç¢¼ï¼ˆ16 å­—å…ƒï¼‰
            STORE_PASS=$(openssl rand -base64 16 | tr -d "=+/" | cut -c1-16)
            KEY_PASS=$(openssl rand -base64 16 | tr -d "=+/" | cut -c1-16)
            ALIAS="unified-remote-evo"

            echo "ç”¢ç”Ÿçš„è³‡è¨Šï¼ˆè«‹è¤‡è£½åˆ° GitHub Secretsï¼‰ï¼š"
            echo "=================================="
            echo "KEY_ALIAS=$ALIAS"
            echo "KEYSTORE_PASSWORD=$STORE_PASS"
            echo "KEY_PASSWORD=$KEY_PASS"
            echo "=================================="

            # ç”¢ç”Ÿ Keystore (ä½¿ç”¨ JKS æ ¼å¼æ”¯æ´ä¸åŒå¯†ç¢¼)
            keytool -genkey -v \
              -keystore app/release.keystore \
              -storetype JKS \
              -alias "$ALIAS" \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass "$STORE_PASS" \
              -keypass "$KEY_PASS" \
              -dname "CN=Unified Remote Evo, OU=Development, O=Personal, L=Taipei, ST=Taiwan, C=TW"

            # è½‰æ›ç‚º Base64
            KEYSTORE_B64=$(base64 -w 0 app/release.keystore)

            echo ""
            echo "KEYSTORE_BASE64ï¼ˆè«‹è¤‡è£½ä»¥ä¸‹å®Œæ•´å…§å®¹ï¼‰ï¼š"
            echo "=================================="
            echo "$KEYSTORE_B64"
            echo "=================================="
            echo ""
            echo "âš ï¸ è«‹å°‡ä»¥ä¸Š 4 å€‹å€¼è¨­å®šåˆ° GitHub Secrets ä¸­ï¼"
            echo "è¨­å®šè·¯å¾‘ï¼šSettings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            echo ""
            echo "è¨­å®šå®Œæˆå¾Œï¼Œè«‹é‡æ–°åŸ·è¡Œæ­¤ workflowã€‚"

            # å„²å­˜åˆ°ç’°å¢ƒè®Šæ•¸ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
            echo "KEYSTORE_PASSWORD=$STORE_PASS" >> $GITHUB_ENV
            echo "KEY_ALIAS=$ALIAS" >> $GITHUB_ENV
            echo "KEY_PASSWORD=$KEY_PASS" >> $GITHUB_ENV
          else
            echo "âœ… æ‰¾åˆ°ç¾æœ‰çš„ç°½ç½²é‡‘é‘°ï¼Œä½¿ç”¨ç¾æœ‰è¨­å®š"
            # é‚„åŸ Keystoreï¼ˆç›´æ¥å¾ secrets è®€å–ï¼Œä¸ç¶“éç’°å¢ƒè®Šæ•¸ï¼‰
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore
          fi

      # 5. é©—è­‰ Keystore æœ‰æ•ˆæ€§
      - name: Verify Keystore
        run: |
          echo "ğŸ” é©—è­‰ Keystore æœ‰æ•ˆæ€§..."

          # æ±ºå®šä½¿ç”¨è‡ªå‹•ç”¢ç”Ÿçš„é‚„æ˜¯ Secrets çš„å¯†ç¢¼
          if [ -n "${{ env.KEYSTORE_PASSWORD }}" ]; then
            # ä½¿ç”¨è‡ªå‹•ç”¢ç”Ÿçš„å¯†ç¢¼
            STORE_PASS="${{ env.KEYSTORE_PASSWORD }}"
            ALIAS="${{ env.KEY_ALIAS }}"
            KEY_PASS="${{ env.KEY_PASSWORD }}"
          else
            # ä½¿ç”¨ Secrets çš„å¯†ç¢¼
            STORE_PASS="${{ secrets.KEYSTORE_PASSWORD }}"
            ALIAS="${{ secrets.KEY_ALIAS }}"
            KEY_PASS="${{ secrets.KEY_PASSWORD }}"
          fi

          # æ¸¬è©¦ KEYSTORE_PASSWORDï¼ˆè®€å– keystoreï¼‰
          if ! keytool -list -keystore app/release.keystore \
               -storepass "$STORE_PASS" \
               -alias "$ALIAS" > /dev/null 2>&1; then
            echo "âŒ Keystore é©—è­‰å¤±æ•—ï¼(KEYSTORE_PASSWORD æˆ– KEY_ALIAS éŒ¯èª¤)"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "1. KEYSTORE_BASE64 è¤‡è£½ä¸å®Œæ•´ï¼ˆæœ€å¸¸è¦‹ï¼‰"
            echo "2. KEYSTORE_PASSWORD ä¸æ­£ç¢º"
            echo "3. KEY_ALIAS ä¸æ­£ç¢º"
            echo ""
            echo "å»ºè­°ï¼š"
            echo "- åˆªé™¤æ‰€æœ‰ Secrets (KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_ALIAS, KEY_PASSWORD)"
            echo "- é‡æ–°åŸ·è¡Œ workflow è®“ç³»çµ±è‡ªå‹•ç”¢ç”Ÿ"
            echo "- å¾æ—¥èªŒè¤‡è£½å®Œæ•´å…§å®¹ï¼ˆåŒ…æ‹¬çµå°¾çš„ = ç¬¦è™Ÿï¼‰"
            exit 1
          fi

          echo "âœ… Step 1: KEYSTORE_PASSWORD é©—è­‰æˆåŠŸ"

          # æ¸¬è©¦ KEY_PASSWORDï¼ˆå–å¾—ç§é‘°ï¼Œé€™æ˜¯ç°½ç½² APK æ™‚æœƒç”¨åˆ°çš„ï¼‰
          echo "ğŸ” é©—è­‰ KEY_PASSWORD..."
          if ! keytool -list -keystore app/release.keystore \
               -storepass "$STORE_PASS" \
               -alias "$ALIAS" \
               -keypass "$KEY_PASS" > /dev/null 2>&1; then
            echo "âŒ KEY_PASSWORD é©—è­‰å¤±æ•—ï¼"
            echo ""
            echo "KEYSTORE_PASSWORD æ­£ç¢ºï¼Œä½† KEY_PASSWORD ä¸æ­£ç¢ºã€‚"
            echo ""
            echo "å»ºè­°ï¼š"
            echo "1. æª¢æŸ¥ KEY_PASSWORD Secret æ˜¯å¦æ­£ç¢º"
            echo "2. æˆ–åˆªé™¤æ‰€æœ‰ 4 å€‹ Secrets é‡æ–°ç”¢ç”Ÿ"
            exit 1
          fi

          echo "âœ… Step 2: KEY_PASSWORD é©—è­‰æˆåŠŸ"
          echo "âœ… Keystore å®Œæ•´é©—è­‰é€šéï¼åˆ¥å: $ALIAS"

          # é¡¯ç¤ºæ†‘è­‰è³‡è¨Šï¼ˆå¯é¸ï¼‰
          keytool -list -keystore app/release.keystore \
                  -storepass "$STORE_PASS" \
                  -alias "$ALIAS" | grep -E "Creation date|å»ºç«‹æ—¥æœŸ" || true

      # 6. å»ºç«‹ keystore.properties
      - name: Create keystore.properties
        run: |
          # æ±ºå®šä½¿ç”¨è‡ªå‹•ç”¢ç”Ÿçš„é‚„æ˜¯ Secrets çš„å¯†ç¢¼
          if [ -n "${{ env.KEYSTORE_PASSWORD }}" ]; then
            # ä½¿ç”¨è‡ªå‹•ç”¢ç”Ÿçš„å¯†ç¢¼
            echo "storeFile=release.keystore" > keystore.properties
            echo "storePassword=${{ env.KEYSTORE_PASSWORD }}" >> keystore.properties
            echo "keyAlias=${{ env.KEY_ALIAS }}" >> keystore.properties
            echo "keyPassword=${{ env.KEY_PASSWORD }}" >> keystore.properties
          else
            # ä½¿ç”¨ Secrets çš„å¯†ç¢¼ï¼ˆç›´æ¥å­˜å–ï¼Œä¸ç¶“éç’°å¢ƒè®Šæ•¸ï¼‰
            echo "storeFile=release.keystore" > keystore.properties
            echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> keystore.properties
            echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
            echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties
          fi

      # 7. ç·¨è­¯ Release APK
      - name: Build Release APK
        run: ./gradlew assembleRelease

      # 8. å–å¾—ç‰ˆæœ¬è™Ÿï¼ˆå¾ tagï¼‰
      - name: Get version
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      # 9. é‡æ–°å‘½å APK
      - name: Rename APK
        run: |
          mv app/build/outputs/apk/release/app-release.apk \
             unified-remote-evo-${{ steps.version.outputs.version }}.apk

      # 10. ä¸Šå‚³ APK ä½œç‚º Artifact
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: unified-remote-evo-${{ steps.version.outputs.version }}
          path: unified-remote-evo-${{ steps.version.outputs.version }}.apk

      # 11. å»ºç«‹ GitHub Releaseï¼ˆåƒ…ç•¶æ¨é€ tag æ™‚ï¼‰
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: unified-remote-evo-${{ steps.version.outputs.version }}.apk
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 12. æ¸…ç†ç°½ç½²é‡‘é‘°
      - name: Cleanup
        if: always()
        run: |
          rm -f app/release.keystore
          rm -f keystore.properties

name: Build and Release APK

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # ç•¶æ¨é€ v1.0.0 ç­‰ tag æ™‚è§¸ç™¼
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  build:
    name: Build Signed APK
    runs-on: ubuntu-latest

    steps:
      # 1. æª¢å‡ºç¨‹å¼ç¢¼
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è¨­å®š JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. è³¦äºˆ Gradle åŸ·è¡Œæ¬Šé™
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. è¨­å®š Gradleï¼ˆè‡ªå‹•å¿«å–ï¼‰
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false
          gradle-home-cache-cleanup: true

      # 4.5. å»ºç«‹ gradle.propertiesï¼ˆç·¨è­¯æœ€ä½³åŒ–ï¼‰
      - name: Create gradle.properties
        run: |
          cat > gradle.properties <<EOF
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.daemon=true
          org.gradle.configureondemand=true
          kotlin.incremental=true
          kotlin.compiler.execution.strategy=in-process
          android.useAndroidX=true
          EOF

      # 5. è¨­å®šç°½ç½²é‡‘é‘°ç’°å¢ƒè®Šæ•¸ï¼ˆçµ±ä¸€è™•ç†ï¼‰
      - name: Setup Signing Environment
        run: |
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ° KEYSTORE_BASE64ï¼Œè‡ªå‹•ç”¢ç”Ÿæ–°çš„ç°½ç½²é‡‘é‘°..."

            # ç”¢ç”Ÿéš¨æ©Ÿå¯†ç¢¼ï¼ˆ16 å­—å…ƒï¼‰
            STORE_PASS=$(openssl rand -base64 16 | tr -d "=+/" | cut -c1-16)
            KEY_PASS=$(openssl rand -base64 16 | tr -d "=+/" | cut -c1-16)
            ALIAS="unified-remote-evo"

            echo "ç”¢ç”Ÿçš„è³‡è¨Šï¼ˆè«‹è¤‡è£½åˆ° GitHub Secretsï¼‰ï¼š"
            echo "=================================="
            echo "KEY_ALIAS=$ALIAS"
            echo "KEYSTORE_PASSWORD=$STORE_PASS"
            echo "KEY_PASSWORD=$KEY_PASS"
            echo "=================================="

            # ç”¢ç”Ÿ Keystore (ä½¿ç”¨ JKS æ ¼å¼æ”¯æ´ä¸åŒå¯†ç¢¼)
            keytool -genkey -v \
              -keystore app/release.keystore \
              -storetype JKS \
              -alias "$ALIAS" \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass "$STORE_PASS" \
              -keypass "$KEY_PASS" \
              -dname "CN=Unified Remote Evo, OU=Development, O=Personal, L=Taipei, ST=Taiwan, C=TW"

            # è½‰æ›ç‚º Base64
            KEYSTORE_B64=$(base64 -w 0 app/release.keystore)

            echo ""
            echo "KEYSTORE_BASE64ï¼ˆè«‹è¤‡è£½ä»¥ä¸‹å®Œæ•´å…§å®¹ï¼‰ï¼š"
            echo "=================================="
            echo "$KEYSTORE_B64"
            echo "=================================="
            echo ""
            echo "âš ï¸ è«‹å°‡ä»¥ä¸Š 4 å€‹å€¼è¨­å®šåˆ° GitHub Secrets ä¸­ï¼"
            echo "è¨­å®šè·¯å¾‘ï¼šSettings â†’ Secrets and variables â†’ Actions â†’ New repository secret"

            # å„²å­˜åˆ°ç’°å¢ƒè®Šæ•¸
            echo "KEYSTORE_PASSWORD=$STORE_PASS" >> $GITHUB_ENV
            echo "KEY_ALIAS=$ALIAS" >> $GITHUB_ENV
            echo "KEY_PASSWORD=$KEY_PASS" >> $GITHUB_ENV
          else
            echo "âœ… æ‰¾åˆ°ç¾æœ‰çš„ç°½ç½²é‡‘é‘°ï¼Œä½¿ç”¨ç¾æœ‰è¨­å®š"
            # é‚„åŸ Keystore
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore

            # çµ±ä¸€å„²å­˜åˆ°ç’°å¢ƒè®Šæ•¸ï¼ˆå¾ŒçºŒæ­¥é©Ÿåªéœ€è®€å– envï¼‰
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
            echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
            echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
          fi

      # 6. é©—è­‰ Keystore æœ‰æ•ˆæ€§ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
      - name: Verify Keystore
        run: |
          echo "ğŸ” å¿«é€Ÿé©—è­‰ Keystore..."

          # åªåšä¸€æ¬¡å¿«é€Ÿé©—è­‰ï¼ˆæ¸›å°‘æ™‚é–“ï¼‰
          if ! keytool -list -keystore app/release.keystore \
               -storepass "${{ env.KEYSTORE_PASSWORD }}" \
               -alias "${{ env.KEY_ALIAS }}" > /dev/null 2>&1; then
            echo "âŒ Keystore é©—è­‰å¤±æ•—ï¼è«‹æª¢æŸ¥ GitHub Secrets è¨­å®š"
            exit 1
          fi

          echo "âœ… Keystore é©—è­‰é€šéï¼"

      # 7. å»ºç«‹ keystore.properties
      - name: Create keystore.properties
        run: |
          # ç›´æ¥ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼ˆç„¡éœ€å†åˆ¤æ–·ä¾†æºï¼‰
          cat > keystore.properties <<EOF
          storeFile=release.keystore
          storePassword=${{ env.KEYSTORE_PASSWORD }}
          keyAlias=${{ env.KEY_ALIAS }}
          keyPassword=${{ env.KEY_PASSWORD }}
          EOF

      # 8. ç·¨è­¯ Release APKï¼ˆé¡¯ç¤ºç·¨è­¯æ™‚é–“ï¼‰
      - name: Build Release APK
        run: |
          echo "ğŸš€ é–‹å§‹ç·¨è­¯..."
          START_TIME=$(date +%s)

          ./gradlew assembleRelease --console=plain --no-daemon --stacktrace

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "âœ… ç·¨è­¯å®Œæˆï¼è€—æ™‚: ${DURATION} ç§’"

      # 9. å–å¾—ç‰ˆæœ¬è™Ÿï¼ˆå¾ tagï¼‰
      - name: Get version
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      # 10. é‡æ–°å‘½å APK
      - name: Rename APK
        run: |
          mv app/build/outputs/apk/release/app-release.apk \
             unified-remote-evo-${{ steps.version.outputs.version }}.apk

      # 11. ä¸Šå‚³ APK ä½œç‚º Artifact
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: unified-remote-evo-${{ steps.version.outputs.version }}
          path: unified-remote-evo-${{ steps.version.outputs.version }}.apk

      # 12. å»ºç«‹ GitHub Releaseï¼ˆåƒ…ç•¶æ¨é€ tag æ™‚ï¼‰
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: unified-remote-evo-${{ steps.version.outputs.version }}.apk
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 13. æ¸…ç†ç°½ç½²é‡‘é‘°
      - name: Cleanup
        if: always()
        run: |
          rm -f app/release.keystore
          rm -f keystore.properties
